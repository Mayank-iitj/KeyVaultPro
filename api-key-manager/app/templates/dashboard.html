<!--
API Key Management System - Dashboard
Designed & Engineered by Mayank Sharma
https://mayyanks.app
-->
{% extends "base.html" %}

{% block title %}Dashboard - API Key Manager{% endblock %}

{% block extra_styles %}
<style>
    .dashboard {
        padding: 40px 0;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }
    
    .page-title {
        font-size: 1.75rem;
        font-weight: 600;
    }
    
    .tabs {
        display: flex;
        gap: 4px;
        background: var(--bg-secondary);
        padding: 4px;
        border-radius: 8px;
        margin-bottom: 24px;
    }
    
    .tab {
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        font-size: 14px;
    }
    
    .tab.active {
        background: var(--accent);
        color: white;
    }
    
    .tab:hover:not(.active) {
        color: var(--text-primary);
    }
    
    .key-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        border-bottom: 1px solid var(--border);
    }
    
    .key-item:last-child {
        border-bottom: none;
    }
    
    .key-info h4 {
        margin-bottom: 4px;
    }
    
    .key-info p {
        color: var(--text-secondary);
        font-size: 14px;
    }
    
    .key-prefix {
        font-family: 'Fira Code', monospace;
        color: var(--accent);
    }
    
    .key-actions {
        display: flex;
        gap: 8px;
    }
    
    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
    }
    
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    
    .modal-overlay.active {
        display: flex;
    }
    
    .modal {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 30px;
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }
    
    .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
    }
    
    .close-btn {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 24px;
        cursor: pointer;
    }
    
    .api-key-display {
        background: var(--bg-secondary);
        border: 1px solid var(--success);
        border-radius: 8px;
        padding: 16px;
        margin: 20px 0;
        word-break: break-all;
        font-family: 'Fira Code', monospace;
        font-size: 14px;
    }
    
    .warning-text {
        color: var(--warning);
        font-size: 14px;
        margin-top: 12px;
    }
    
    .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 8px;
    }
    
    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .checkbox-item input {
        width: 16px;
        height: 16px;
    }
    
    #login-section {
        max-width: 400px;
        margin: 60px auto;
    }
    
    #dashboard-content {
        display: none;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }
    
    .empty-state h3 {
        margin-bottom: 12px;
        color: var(--text-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="container dashboard">
    <div id="login-section">
        <div class="card">
            <h2 style="margin-bottom: 24px; text-align: center;">Login to Dashboard</h2>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="login-email" class="input" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="login-password" class="input" placeholder="Your password">
            </div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="login()">Login</button>
            <p style="text-align: center; margin-top: 16px; color: var(--text-secondary); font-size: 14px;">
                Don't have an account? Use the API to register first.
            </p>
            <div id="login-error" class="alert alert-danger" style="display: none; margin-top: 16px;"></div>
        </div>
    </div>
    
    <div id="dashboard-content">
        <div class="page-header">
            <h1 class="page-title">API Keys Dashboard</h1>
            <div>
                <button class="btn btn-secondary" onclick="refreshKeys()">Refresh</button>
                <button class="btn btn-primary" onclick="showCreateModal()">+ Create Key</button>
            </div>
        </div>
        
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="stat-total">0</div>
                <div class="stat-label">Total Keys</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-active">0</div>
                <div class="stat-label">Active Keys</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-disabled">0</div>
                <div class="stat-label">Disabled</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-revoked">0</div>
                <div class="stat-label">Revoked</div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="filterKeys('all')">All Keys</button>
            <button class="tab" onclick="filterKeys('active')">Active</button>
            <button class="tab" onclick="filterKeys('disabled')">Disabled</button>
            <button class="tab" onclick="filterKeys('revoked')">Revoked</button>
        </div>
        
        <div class="card">
            <div id="keys-list">
                <div class="empty-state">
                    <h3>No API Keys Found</h3>
                    <p>Create your first API key to get started.</p>
                </div>
            </div>
        </div>
        
        <button class="btn btn-secondary" onclick="logout()" style="margin-top: 20px;">Logout</button>
    </div>
</div>

<div class="modal-overlay" id="create-modal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Create API Key</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="form-group">
            <label class="form-label">Key Name *</label>
            <input type="text" id="key-name" class="input" placeholder="My API Key">
        </div>
        <div class="form-group">
            <label class="form-label">Description</label>
            <input type="text" id="key-description" class="input" placeholder="Optional description">
        </div>
        <div class="form-group">
            <label class="form-label">Permissions</label>
            <div class="checkbox-group">
                <label class="checkbox-item">
                    <input type="checkbox" id="perm-read" checked>
                    <span>Read</span>
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" id="perm-write">
                    <span>Write</span>
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" id="perm-delete">
                    <span>Delete</span>
                </label>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Environment</label>
            <select id="key-environment" class="input">
                <option value="production">Production</option>
                <option value="staging">Staging</option>
                <option value="development">Development</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Expires In (days)</label>
            <input type="number" id="key-expires" class="input" placeholder="90 (optional)">
        </div>
        <button class="btn btn-primary" style="width: 100%;" onclick="createKey()">Create Key</button>
    </div>
</div>

<div class="modal-overlay" id="key-created-modal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">API Key Created</h3>
            <button class="close-btn" onclick="closeKeyCreatedModal()">&times;</button>
        </div>
        <div class="alert alert-success">
            Your API key has been created successfully!
        </div>
        <p style="margin-bottom: 12px;">Copy your API key now. You won't be able to see it again!</p>
        <div class="api-key-display" id="new-api-key"></div>
        <button class="btn btn-primary" style="width: 100%;" onclick="copyKey()">Copy to Clipboard</button>
        <p class="warning-text">⚠️ Store this key securely. It will not be shown again.</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let accessToken = localStorage.getItem('access_token');
    let allKeys = [];
    
    if (accessToken) {
        showDashboard();
        loadKeys();
    }
    
    async function login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const errorDiv = document.getElementById('login-error');
        
        try {
            const response = await fetch('/api/v1/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                localStorage.setItem('access_token', data.access_token);
                localStorage.setItem('refresh_token', data.refresh_token);
                accessToken = data.access_token;
                showDashboard();
                loadKeys();
            } else {
                errorDiv.textContent = data.detail || 'Login failed';
                errorDiv.style.display = 'block';
            }
        } catch (error) {
            errorDiv.textContent = 'Connection error';
            errorDiv.style.display = 'block';
        }
    }
    
    function logout() {
        localStorage.removeItem('access_token');
        localStorage.removeItem('refresh_token');
        accessToken = null;
        document.getElementById('login-section').style.display = 'block';
        document.getElementById('dashboard-content').style.display = 'none';
    }
    
    function showDashboard() {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('dashboard-content').style.display = 'block';
    }
    
    async function loadKeys() {
        try {
            const response = await fetch('/api/v1/keys', {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            
            if (response.status === 401) {
                logout();
                return;
            }
            
            const data = await response.json();
            allKeys = data.items || [];
            updateStats();
            renderKeys(allKeys);
        } catch (error) {
            console.error('Failed to load keys:', error);
        }
    }
    
    function updateStats() {
        document.getElementById('stat-total').textContent = allKeys.length;
        document.getElementById('stat-active').textContent = allKeys.filter(k => k.status === 'active').length;
        document.getElementById('stat-disabled').textContent = allKeys.filter(k => k.status === 'disabled').length;
        document.getElementById('stat-revoked').textContent = allKeys.filter(k => k.status === 'revoked').length;
    }
    
    function renderKeys(keys) {
        const container = document.getElementById('keys-list');
        
        if (keys.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>No API Keys Found</h3>
                    <p>Create your first API key to get started.</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = keys.map(key => `
            <div class="key-item">
                <div class="key-info">
                    <h4>${key.name}</h4>
                    <p>
                        <span class="key-prefix">${key.key_prefix}...</span> | 
                        ${key.permissions.join(', ')} | 
                        ${key.environment}
                    </p>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="badge badge-${key.status === 'active' ? 'success' : key.status === 'disabled' ? 'warning' : 'danger'}">
                        ${key.status}
                    </span>
                    <div class="key-actions">
                        ${key.status === 'active' ? `<button class="btn btn-secondary btn-sm" onclick="disableKey('${key.id}')">Disable</button>` : ''}
                        ${key.status === 'disabled' ? `<button class="btn btn-secondary btn-sm" onclick="enableKey('${key.id}')">Enable</button>` : ''}
                        ${key.status !== 'revoked' ? `<button class="btn btn-secondary btn-sm" onclick="revokeKey('${key.id}')">Revoke</button>` : ''}
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    function filterKeys(status) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        
        const filtered = status === 'all' ? allKeys : allKeys.filter(k => k.status === status);
        renderKeys(filtered);
    }
    
    function showCreateModal() {
        document.getElementById('create-modal').classList.add('active');
    }
    
    function closeModal() {
        document.getElementById('create-modal').classList.remove('active');
    }
    
    function closeKeyCreatedModal() {
        document.getElementById('key-created-modal').classList.remove('active');
        loadKeys();
    }
    
    async function createKey() {
        const name = document.getElementById('key-name').value;
        const description = document.getElementById('key-description').value;
        const environment = document.getElementById('key-environment').value;
        const expiresIn = document.getElementById('key-expires').value;
        
        const permissions = [];
        if (document.getElementById('perm-read').checked) permissions.push('read');
        if (document.getElementById('perm-write').checked) permissions.push('write');
        if (document.getElementById('perm-delete').checked) permissions.push('delete');
        
        const body = {
            name,
            description: description || undefined,
            permissions,
            environment,
            expires_in_days: expiresIn ? parseInt(expiresIn) : undefined
        };
        
        try {
            const response = await fetch('/api/v1/keys', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });
            
            const data = await response.json();
            
            if (response.ok) {
                closeModal();
                document.getElementById('new-api-key').textContent = data.api_key;
                document.getElementById('key-created-modal').classList.add('active');
            } else {
                alert(data.detail || 'Failed to create key');
            }
        } catch (error) {
            alert('Connection error');
        }
    }
    
    function copyKey() {
        const key = document.getElementById('new-api-key').textContent;
        navigator.clipboard.writeText(key);
        alert('Copied to clipboard!');
    }
    
    async function disableKey(keyId) {
        await fetch(`/api/v1/keys/${keyId}/disable`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        loadKeys();
    }
    
    async function enableKey(keyId) {
        await fetch(`/api/v1/keys/${keyId}/enable`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        loadKeys();
    }
    
    async function revokeKey(keyId) {
        if (confirm('Are you sure you want to revoke this key? This cannot be undone.')) {
            await fetch(`/api/v1/keys/${keyId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            loadKeys();
        }
    }
    
    function refreshKeys() {
        loadKeys();
    }
</script>
{% endblock %}
